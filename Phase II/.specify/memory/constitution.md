<!--
  SYNC IMPACT REPORT
  ==================
  Version change: 0.0.0 → 1.0.0 (MAJOR - initial ratification)

  Modified principles: N/A (new constitution)

  Added sections:
    - I. Multi-Tier Isolation
    - II. Persistence First
    - III. Secure by Design
    - IV. Zero Manual Coding
    - V. Test-First Discipline
    - VI. API Contract Enforcement
    - Technology Standards section
    - Development Workflow section
    - Governance section

  Removed sections: N/A (new constitution)

  Templates requiring updates:
    - ✅ plan-template.md (already aligned - Constitution Check section exists)
    - ✅ spec-template.md (already aligned - functional requirements structure)
    - ✅ tasks-template.md (already aligned - supports web app structure)

  Follow-up TODOs: None
-->

# Full-Stack Todo Evolution (Phase 2) Constitution

## Core Principles

### I. Multi-Tier Isolation

All Phase 2 code MUST reside strictly within the designated directory structure:
- Frontend code: `/frontend/`
- Backend code: `/backend/`

**Rationale**: Clear separation enables independent deployment, testing, and scaling of frontend and backend tiers. This isolation prevents accidental cross-contamination with Phase 1 code and maintains clean architectural boundaries.

**Enforcement**:
- Code reviews MUST reject any Phase 2 code outside designated directories
- Build pipelines MUST only process files within the isolation boundary
- Shared types or contracts MUST be duplicated or published as packages, never imported across tiers directly

### II. Persistence First

All data MUST be persisted to Neon PostgreSQL using SQLModel as the ORM layer. In-memory storage is prohibited for production data.

**Rationale**: Phase 2 evolves the todo application from ephemeral in-memory storage to durable, queryable persistence. SQLModel provides type-safe Python models that integrate seamlessly with FastAPI and Pydantic validation.

**Requirements**:
- Every entity MUST have a corresponding SQLModel class
- Database migrations MUST be managed via Alembic
- Connection pooling MUST be configured for production workloads
- All queries MUST use parameterized statements (SQLModel handles this by default)

### III. Secure by Design

Every API request MUST be validated via Better Auth JWT tokens. No unauthenticated endpoints are permitted except health checks and public metadata.

**Rationale**: Security is not an afterthought. Authentication and authorization MUST be baked into the architecture from day one to prevent data leakage and unauthorized access.

**Requirements**:
- JWT verification MUST use shared secret between Next.js and FastAPI
- Tokens MUST include user identity claims for authorization decisions
- Token expiry MUST be enforced; refresh token flow MUST be implemented
- All endpoints MUST declare their authentication requirements explicitly
- Failed authentication MUST return 401; failed authorization MUST return 403

### IV. Zero Manual Coding

All code within the `/phase-2-web/` directory MUST be generated by Claude Code. Manual edits are prohibited.

**Rationale**: This project demonstrates AI-assisted development workflow. Maintaining this constraint ensures reproducibility, traceability, and validates the AI coding assistant's capabilities.

**Enforcement**:
- Every code change MUST be traceable to a Claude Code session via PHR
- Manual hotfixes are prohibited; issues MUST be resolved through new Claude Code prompts
- Code reviews MUST verify AI-generation provenance

### V. Test-First Discipline

Tests SHOULD be written before implementation when explicitly requested. Red-Green-Refactor cycle is the preferred development pattern.

**Rationale**: Test-first development catches design issues early and ensures every feature has verification coverage from inception.

**Guidelines**:
- Contract tests for API endpoints SHOULD be defined before implementation
- Integration tests SHOULD cover critical user journeys
- Unit tests SHOULD cover business logic in isolation
- Test files MUST reside in appropriate `tests/` directories per tier

### VI. API Contract Enforcement

Frontend and backend MUST communicate exclusively via REST API with JSON payloads. Contracts MUST be documented and versioned.

**Rationale**: Explicit contracts enable independent development of frontend and backend, facilitate testing, and provide clear documentation for API consumers.

**Requirements**:
- All endpoints MUST follow REST conventions (proper HTTP methods, status codes)
- Request/response schemas MUST be documented (OpenAPI/Swagger auto-generation via FastAPI)
- Breaking changes MUST increment API version
- Error responses MUST follow a consistent structure

## Technology Standards

**Backend Stack**:
- Language: Python 3.13+
- Framework: FastAPI (latest stable)
- ORM: SQLModel
- Database: Neon PostgreSQL
- Auth: Better Auth JWT (shared secret verification)

**Frontend Stack**:
- Framework: Next.js 16+ (App Router)
- Styling: Tailwind CSS
- Language: TypeScript (strict mode)
- Auth: Better Auth client integration

**Communication**:
- Protocol: HTTPS (HTTP for local development)
- Format: JSON
- API Style: RESTful

**Development Tools**:
- Package Management: uv (backend), npm/pnpm (frontend)
- Linting: ruff (backend), ESLint (frontend)
- Formatting: ruff format (backend), Prettier (frontend)
- Testing: pytest (backend), Jest/Vitest (frontend)

## Development Workflow

**Spec-Driven Development (SDD) Cycle**:
1. `/sp.specify` - Define feature requirements and acceptance criteria
2. `/sp.plan` - Create implementation architecture and technical design
3. `/sp.tasks` - Generate actionable, dependency-ordered tasks
4. `/sp.implement` - Execute tasks with AI assistance
5. Validate against spec and iterate

**Version Control**:
- Feature branches: `###-feature-name` format
- Commits MUST reference task IDs when applicable
- PRs MUST include summary and test plan

**Quality Gates**:
- All tests MUST pass before merge
- Linting MUST pass with zero warnings
- Type checking MUST pass (mypy for Python, tsc for TypeScript)
- Security scans SHOULD be run on PRs

## Governance

This constitution supersedes all other development practices for Phase 2 of the Full-Stack Todo Evolution project.

**Amendment Process**:
1. Propose change via `/sp.constitution` command with rationale
2. Document impact on existing code and templates
3. Update version according to semantic versioning:
   - MAJOR: Principle removal or backward-incompatible redefinition
   - MINOR: New principle or materially expanded guidance
   - PATCH: Clarifications, wording, or non-semantic refinements
4. Update dependent templates and documentation

**Compliance**:
- All PRs MUST verify compliance with applicable principles
- Violations MUST be documented with justification in Complexity Tracking
- Architectural decisions SHOULD be recorded via ADR when meeting significance criteria

**Runtime Guidance**:
- Use `.specify/` templates for all specification artifacts
- Consult this constitution before making architectural decisions
- When in doubt, ask for clarification rather than assume

**Version**: 1.0.0 | **Ratified**: 2026-01-22 | **Last Amended**: 2026-01-22
