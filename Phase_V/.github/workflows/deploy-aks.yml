name: Build and Deploy to AKS

on:
  push:
    branches:
      - main
    paths:
      - "backend/**"
      - "frontend/**"
      - "services/**"
      - "helm/**"
      - ".github/workflows/**"

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ghcr.io/${{ github.repository_owner }}

jobs:
  build-and-push:
    name: Build and Push (${{ matrix.service }})
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    strategy:
      matrix:
        include:
          - service: backend
            context: .
            dockerfile: backend/Dockerfile
          - service: frontend
            context: frontend
            dockerfile: frontend/Dockerfile
          - service: recurring-service
            context: services/recurring-service
            dockerfile: services/recurring-service/Dockerfile
          - service: notification-service
            context: services/notification-service
            dockerfile: services/notification-service/Dockerfile

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.REGISTRY_PASSWORD }}

      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_PREFIX }}/${{ matrix.service }}
          tags: |
            type=raw,value=main-${{ github.sha }}
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.dockerfile }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=${{ matrix.service }}
          cache-to: type=gha,mode=max,scope=${{ matrix.service }}

  deploy-helm:
    name: Deploy to AKS
    runs-on: ubuntu-latest
    needs: build-and-push
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: "v1.27.0"

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: "v3.12.0"

      - name: Configure kubeconfig
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBECONFIG }}" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config

      - name: Add Helm repositories
        run: |
          helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
          helm repo add jetstack https://charts.jetstack.io
          helm repo add kedacore https://kedacore.github.io/charts
          helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
          helm repo update

      - name: Create GHCR image pull secret
        run: |
          kubectl create secret docker-registry ghcr-pull-secret \
            --docker-server=ghcr.io \
            --docker-username=${{ github.actor }} \
            --docker-password=${{ secrets.REGISTRY_PASSWORD }} \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: Deploy backend
        run: |
          helm upgrade --install backend ./helm/backend \
            -f ./helm/backend/values-aks.yaml \
            --set image.tag=main-${{ github.sha }} \
            --set image.pullSecrets[0].name=ghcr-pull-secret \
            --wait --timeout 5m

      - name: Deploy frontend
        run: |
          helm upgrade --install frontend ./helm/frontend \
            -f ./helm/frontend/values-aks.yaml \
            --set image.tag=main-${{ github.sha }} \
            --set image.pullSecrets[0].name=ghcr-pull-secret \
            --wait --timeout 5m

      - name: Deploy recurring-service
        run: |
          helm upgrade --install recurring-service ./helm/recurring-service \
            -f ./helm/recurring-service/values-aks.yaml \
            --set image.tag=main-${{ github.sha }} \
            --set image.pullSecrets[0].name=ghcr-pull-secret \
            --wait --timeout 5m

      - name: Deploy notification-service
        run: |
          helm upgrade --install notification-service ./helm/notification-service \
            -f ./helm/notification-service/values-aks.yaml \
            --set image.tag=main-${{ github.sha }} \
            --set image.pullSecrets[0].name=ghcr-pull-secret \
            --wait --timeout 5m

      - name: Verify rollout status
        run: |
          kubectl rollout status deployment/backend --timeout=120s
          kubectl rollout status deployment/frontend --timeout=120s
          kubectl rollout status deployment/recurring-service --timeout=120s
          kubectl rollout status deployment/notification-service --timeout=120s

      - name: Health check
        run: |
          # Wait for ingress to stabilize
          sleep 30
          # Basic connectivity check (update domain as needed)
          curl -sf https://api.yourdomain.com/health || echo "Health check skipped (DNS may not be configured)"
